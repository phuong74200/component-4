const Anvil=function(e){e={init:{create:function(){},loaded:function(){}},...e},this["[[holder]]"]={Handles:{i:[],m:{}},Components:{i:[],m:{}},loadStacks:[]};const t=this["[[holder]]"],n=(e,t)=>{"/"!=e.slice(-1)&&(e+="/");var n=e.split("/"),o=t.split("/");n.pop();for(var s=0;s<o.length;s++)"."!=o[s]&&(".."==o[s]?n.pop():n.push(o[s]));return n.join("/")};this.Handle=function(e="String",n=(()=>{})){t.Handles.m[e]?console.warn(`Handler named '${e}' has already taken`):(t.Handles.i.push(n),t.Handles.m[e]=n)};const o=(e,n=new n,o=new o)=>{e&&(t.Handles.m[e]?t.Handles.m[e]({Listen:o,Render:n}):console.warn(`Handler named '${e}' not created yet!`))};this.load={fromNode:e=>{new function(e){this.name=e.getAttribute("*name").toUpperCase(),this.props=[...e.querySelectorAll("prop")].map(e=>({name:e.getAttribute("*name"),type:e.getAttribute("*type")||"String",defl:e.textContent})),this.render=e.querySelector("render").cloneNode(!0),this.handles={change:e.getAttribute("(change)"),update:e.getAttribute("(update)"),render:e.getAttribute("(render)")},"COMPONENT"==e.tagName?(t.Components.i.push(this),t.Components.m[this.name]=this):console.warn(`${e} is not a component! Change its tagName to component`)}(e)},fromFile:e=>new Promise((t,n)=>{fetch(e).then(e=>e.text()).then(e=>{const n=document.createElement("div");n.innerHTML=e;for(let e of n.querySelectorAll("component"))this.load.fromNode(e);t(n),r()})}),fromMeta:e=>new Promise((t,o)=>{fetch(e).then(e=>e.json()).then(o=>{const s=e.split("/").slice(0,-1).join("/");if(o.path={css:n(s,o.path.css),html:n(s,o.path.html),js:n(s,o.path.js)},!document.querySelector(`link[href="${o.path.css}"]`)){var r=document.createElement("link");r.href=o.path.css,r.type="text/css",r.rel="stylesheet",document.getElementsByTagName("head")[0].appendChild(r)}document.querySelector(`script[src="${o.path.js}"]`)?(this.load.fromFile(o.path.html),t(o)):fetch(o.path.js).then(e=>e.text()).then(e=>{console.log("repeat"),new Function(e).apply({Handle:this.Handle}),this.load.fromFile(o.path.html),t(o)})})}),fromPack:(e,t=!1)=>{fetch(e).then(e=>e.text()).then(e=>{let n=document.createElement("div");n.innerHTML=e;let o=n.querySelector("component"),s=n.querySelector("script")?.innerHTML,a=n.querySelector("style")?.innerHTML;if(o&&this.load.fromNode(o),new Function(s).apply({Handle:this.Handle}),a){let e=document.createElement("style");e.innerHTML=t?function(e){return e=e.replace(/([^0-9a-zA-Z\.#])\s+/g,"$1").replace(/\s([^0-9a-zA-Z\.#]+)/g,"$1").replace(/;}/g,"}").replace(/\/\*.*?\*\//g,"")}(a):a,document.querySelector("head").appendChild(e)}r()})}},e.init.ComponentInit.bind(this)(),e.init.HandleInit.bind(this)();const s=function(e){this.node=e,this.cData=t.Components.m[e.tagName],this.clone=this.cData.render.querySelector("*").cloneNode(!0),this.props=this.cData.props,(root=this.clone.querySelector("root"))&&root.replaceWith(...e.children),e.replaceWith(this.clone),((e,t)=>{for(let n of e.attributes)"class"==n.nodeName?t.classList.add(n.nodeValue):t.setAttribute(n.nodeName,n.nodeValue);t.querySelectorAll("*")})(e,this.clone);let n=new function(e=new e){this.Render=e;let t=e.cData,n=e.node;this["[[hold]]"]={props:{},includes:[]};let s=this["[[hold]]"];this.props=s.props;const r=n=>{for(let r of s.includes)if(r.expression.includes(n)){let n=r.expression.replace(/\{\{(.*?)\}\}/g,e=>l(e,r.node));n!=r.node.textContent&&(r.node.textContent=n,o(t.handles.change,e,this))}o(t.handles.update,e,this)},a=(e,t)=>"Number"==t?Number(e):"Int"==t?parseInt(e):"Float"==t?parseFloat(e):"Date"==t?Date(e):String(e),l=e=>{let n=t.props.map(e=>e.name);return e=e.slice(2,e.length-2),new Function(...n,`return ${e}`).apply(null,Object.values(s.props))},i=e=>{if(3==e.nodeType)e.textContent=e.textContent.replace(/\{\{(.*?)\}\}/g,t=>{let n=l(t,e);return s.includes.push({node:e,expression:e.textContent}),n});else if(e.attributes)for(let t of e.attributes)"*src"==t.name&&e.setAttribute("src",t.value),t.value=t.value.replace(/\{\{(.*?)\}\}/g,e=>{let n=l(e);return s.includes.push({node:t,expression:t.value}),n});for(let t of e.childNodes)i(t)};(o=>{for(let o of t.props)s.props["_"+o.name]=a(n.getAttribute(o.name),o.type),Object.defineProperty(s.props,o.name,{get:function(){return a(s.props["_"+o.name],o.type)},set:function(e){s.props["_"+o.name]=a(e,o.type),r(o.name)}}),e.clone.removeAttribute(o.name)})(),i(e.clone)}(this);for(let e of t.Components.i)for(;this.clone.getElementsByTagName(e.name).length>0;)new s(this.clone.getElementsByTagName(e.name)[0]);o(this.cData.handles.render,this,n)},r=()=>{for(let e of t.Components.i)for(;document.getElementsByTagName(e.name).length>0;)new s(document.getElementsByTagName(e.name)[0])};r(),new MutationObserver((e,n)=>{for(const n of e)if("childList"===n.type){let e=n.addedNodes[n.addedNodes.length-1];e&&1==e.nodeType&&t.Components.m[e.tagName]&&new s(e)}}).observe(document.body,{attributes:!0,childList:!0,subtree:!0})};